{
	"name": "19-cleanup-sql-pool",
	"properties": {
		"folder": {
			"name": "DP203/Initial Setup Scripts"
		},
		"content": {
			"query": "-- DROP VIEWS\n\nIF OBJECT_ID(N'[wwi_perf].[mvCustomerSales]') IS NOT NULL\ndrop view [wwi_perf].[mvCustomerSales]\n\nIF OBJECT_ID(N'[wwi_perf].[vTableSizes]') IS NOT NULL\ndrop view [wwi_perf].[vTableSizes]\n\nIF OBJECT_ID(N'[wwi_perf].[vColumnStoreRowGroupStats]') IS NOT NULL\ndrop view [wwi_perf].[vColumnStoreRowGroupStats]\n\nIF OBJECT_ID(N'[dbo].[mvTransactionItemsCounts]') IS NOT NULL\ndrop view dbo.mvTransactionItemsCounts\n\n-- DROP STATISTICS\nIF EXISTS(select * from sys.stats where name = 'Sale_Hash_CustomerId')\nDROP STATISTICS wwi_perf.Sale_Hash.Sale_Hash_CustomerId\n\n-- DROP INDEXES\n\nIF EXISTS(select * from sys.indexes where name = 'Store_Index')\ndrop index Store_Index on [wwi_perf].[Sale_Index]\n\n-- DROP TABLES\n\nIF OBJECT_ID(N'[wwi_staging].[SaleHeap]') IS NOT NULL   \nDROP TABLE [wwi_staging].[SaleHeap]\n\nIF OBJECT_ID(N'[wwi_staging].[Sale]') IS NOT NULL  \ndrop table wwi_staging.Sale\n\nIF OBJECT_ID(N'[wwi_staging].[DailySalesCounts]') IS NOT NULL  \ndrop table wwi_staging.DailySalesCounts\n\nIF OBJECT_ID(N'[wwi].[CampaignAnalytics]') IS NOT NULL  \ndrop table wwi.CampaignAnalytics\n\nIF OBJECT_ID(N'[wwi].[UserProductReviews]') IS NOT NULL \ndrop table wwi.UserProductReviews\n\nIF OBJECT_ID(N'[wwi].[UserTopProductPurchases]') IS NOT NULL \ndrop table wwi.UserTopProductPurchases\n\nIF OBJECT_ID(N'[wwi_perf].[Sale_Hash]') IS NOT NULL \ndrop table [wwi_perf].[Sale_Hash]\n\nIF OBJECT_ID(N'[wwi_perf].[Sale_Hash_Projection]') IS NOT NULL \ndrop table [wwi_perf].[Sale_Hash_Projection]\n\nIF OBJECT_ID(N'[wwi_perf].[Sale_Hash_Projection2]') IS NOT NULL \ndrop table [wwi_perf].[Sale_Hash_Projection2]\n\nIF OBJECT_ID(N'[wwi_perf].[Sale_Hash_Projection_Big]') IS NOT NULL \ndrop table [wwi_perf].[Sale_Hash_Projection_Big]\n\nIF OBJECT_ID(N'[wwi_perf].[Sale_Hash_Projection_Big2]') IS NOT NULL \ndrop table [wwi_perf].[Sale_Hash_Projection_Big2]\n\nIF OBJECT_ID(N'[wwi_perf].[Sale_Hash_v2]') IS NOT NULL \ndrop table [wwi_perf].[Sale_Hash_v2]\n\nIF OBJECT_ID(N'[wwi_ml].[ProductPCA]') IS NOT NULL \ndrop table wwi_ml.ProductPCA\n\nIF OBJECT_ID(N'[wwi].[Recommendations]') IS NOT NULL \ndrop table wwi.Recommendations\n\nIF OBJECT_ID(N'[wwi_external].[DailySalesCounts]') IS NOT NULL \ndrop external table [wwi_external].DailySalesCounts\n\nIF OBJECT_ID(N'[wwi_external].[Sales]') IS NOT NULL \ndrop external table [wwi_external].Sales\n\nIF OBJECT_ID(N'[external].[DailySalesCounts]') IS NOT NULL \ndrop external table [external].DailySalesCounts\n\nIF OBJECT_ID(N'[external].[Sales]') IS NOT NULL \ndrop external table [external].Sales\n\nIF OBJECT_ID(N'[wwi_ml].[MLModel]') IS NOT NULL \ntruncate table [wwi_ml].[MLModel]\n\n-- DROP SCHEMAS\n\nIF EXISTS (select * from sys.schemas where name = 'wwi_external')\nDROP SCHEMA [wwi_external]\n\nIF EXISTS (select * from sys.schemas where name = 'external')\nDROP SCHEMA [external]\n\nIF EXISTS (select * from sys.schemas where name = 'wwi_staging')\nDROP SCHEMA [wwi_staging]\n\n-- DROP EXTERNAL FILE FORMATS\n\nIF EXISTS(select * from sys.external_file_formats where name = 'csv_dailysales')\ndrop external file format csv_dailysales\n\nIF EXISTS(select * from sys.external_file_formats where name = 'ParquetFormat')\ndrop external file format ParquetFormat\n\n-- DROP EXTERNAL DATA SOURCES\n\nIF EXISTS(select * from sys.external_data_sources where name = 'ABSS')\ndrop external data source ABSS\n\n-- DROP WORKLOAD CLASSIFIERS\n\nIF EXISTS (SELECT * FROM sys.workload_management_workload_classifiers WHERE name = 'CEO')\nDROP WORKLOAD CLASSIFIER CEO;\n\nIF EXISTS (SELECT * FROM sys.workload_management_workload_classifiers where name = 'CEODreamDemo')\nDROP WORKLOAD CLASSIFIER CEODreamDemo\n\nIF EXISTS (SELECT * FROM sys.workload_management_workload_classifiers where name = 'HeavyLoader')\nDROP WORKLOAD Classifier HeavyLoader\n\n-- DROP WORKLOAD GROUPS\n\nIF EXISTS (SELECT * FROM sys.workload_management_workload_groups where name = 'BigDataLoad')\nDROP WORKLOAD GROUP BigDataLoad\n\nIF EXISTS (SELECT * FROM sys.workload_management_workload_groups where name = 'CEODemo')\nDROP WORKLOAD GROUP CEODemo\n\n-- DROP SECURITY POLICIES\n\nIF EXISTS (select * from sys.security_policies where name = 'SalesFilter')\nBEGIN\n    ALTER SECURITY POLICY SalesFilter  \n    WITH (STATE = OFF);\n\n    DROP SECURITY POLICY SalesFilter;\nEND\n\n-- DROP FUNCTIONS\n\nIF EXISTS (select * from sys.sql_modules M join sys.objects O on M.object_id = O.object_id where name = 'fn_securitypredicate')\nDROP FUNCTION wwi_security.fn_securitypredicate\n\n-- DROP MASKED COLUMNS \n\nIF EXISTS (\n    select \n        *\n    from \n        sys.masked_columns MC\n        join sys.tables T ON\n            MC.object_id = T.object_id\n        join sys.schemas S ON\n            T.schema_id = S.schema_id\n    WHERE\n        MC.is_masked = 1\n        AND S.name = 'wwi_security'\n        AND T.name = 'CustomerInfo'\n        AND MC.name = 'CreditCard'\n)\nBEGIN\n    ALTER TABLE wwi_security.CustomerInfo\n    ALTER COLUMN [CreditCard] DROP MASKED;\nEND\n\nIF EXISTS (\n    select \n        *\n    from \n        sys.masked_columns MC\n        join sys.tables T ON\n            MC.object_id = T.object_id\n        join sys.schemas S ON\n            T.schema_id = S.schema_id\n    WHERE\n        MC.is_masked = 1\n        AND S.name = 'wwi_security'\n        AND T.name = 'CustomerInfo'\n        AND MC.name = 'Email'\n)\nBEGIN\n    ALTER TABLE wwi_security.CustomerInfo\n    ALTER COLUMN [Email] DROP MASKED;\nEND",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "master",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}